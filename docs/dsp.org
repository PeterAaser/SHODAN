* Rewritten from the circus of shit that is the DSP wiki
** STG overview
   [[file:img/mcs_overview.png]]
    
   An STG consists of the following:
   + 60 electrode channels
   + 3 DAC pairs
   + 3 Sidebands
   + 3 Trigger statemachines

   TODO This is incomprehensible, Fix after doing the last part.
   The trigger statemachines control the 
   Within each module, the three DAC pairs and three sideband
   channels can be arbitrary controlled by three trigger statemachines. These
   statemachines handle the stimulus pattern read out units (DAC/SBS) to whom they
   are assigned to (reg:0x104­0x108). The stimulus pattern is stored in onboard
   memory on the MEA2100 headstage where each module has its own independent
   memory. For the stimulation (DAC/SBS) the memory is organized in segments and
   blocks to support the stimulus with different stimulus pattern lists, to enable
   quick switching between lists of prepared patterns. The DACs update their output
   value every 20 us, resulting in an output rate of 50 kHz. Corresponding for the
   analog patterns, additional information is stored in memory regions called
   sidebands. These sideband data contain digital information for controling the
   switches and muxes to enable stimulation. The update of this data is also every
   20 us. 

   The electrical parameters are: 
   + Voltage Mode 
     * Range: +- 12 V
     * Resolution: 0.571 mV per digit
   + Current Mode: 
     * Range: +- 1.5 mA, 
     * Resolution: 0.05 µA per digit

   The configuration of the Stimulus Generator consists of three parts: 

   + Stimulus pattern upload 
   + Electrode configuration 
   + Trigger setup 

   remove?
   The configuration of the Direct Streaming mode can be done in two ways:
   When controled by Computer SW via DSP 
   When fully controled by DSP Stimulus

** Pattern Upload 
   
   [[file:img/mcs_stim_mem.png]]
   
   The patterns used to stimulate electrodes is held in the stimulus memory as 
   shown in the figure.
   This data is read by 8 stimulus pattern readout units, however in default
   configuration only 6 of them are in use: One for each sideband, and one for
   each DAC.
   
   The memory is divided into segments of blocks. Only the base case with one
   segment will be considered for now. Setup is handled by writing to the memory 
   control register.

   After setting up the memory data is written by using the DAC and SBS write
   registers at 0x9F20 - 0x9F3C.
   Writing to these registers appends data to the corresponding block, take
   care not to write more data than each block has allocated.
   
   TODO Describe these
   Interesting registers: 
   + 0x9F20 - 0x9F3c
   + 0x9200 - 0x9200 ... - 0x92E0
   + 0x9F40 - 0x9F54

*** A whole lot of indecipherable MCS shit about ↑
    The data vector (000) is either a value with a 16 bit amplitude for DACs or
    16 bit Sideband Signal value for Sideband Channels. Bit 26 defines the
    timebase of this vector. A '0' defines that the value will be valid for one
    20 us frame until the number of repeats (bits 25­16) will be decreased by
    one. If bit 26 is '1' the value will be valid for 1000 times 20 us until the
    decrement will be done. Two kind of loops can be used. A single vector loop
    (001) and a long loop vector (010 in combination with 011) with two vectors
    keeping the information. For both types of loops the "number of repeats" are
    one based. Whereby a 0x1 will lead to ignore the vector and a 0x2 will
    repeat once. A value of 0x0 means to loop forever! The address offset is
    also one based. A 0x1 will jump backward on
    

** DAC Units 
   The STG comes with 6 DACs, which in defaul configuration forms three pairs, each 
   pair covering 30 electrodes each. 
   This is the same as stating that the 60 electros is divided into two groups of 
   electrodes, each group covered by 3 DACs.
   
   In this setup each DAC pair operates as one logic unit, such that the programmer
   only has to consider three DACs covering 60 electrodes, however if necessary
   each pair can be broken up allowing for 6 individual DACs, each DAC restricted 
   to 30 electrodes.
   
   default configuration these six DACs are combined into three DAC pairs, so that
   each pair appear as a single DAC capable of stimulating all 60 electrodes.
   
   For advanced applications, these DAC pairs can be broken up, allowing
   stimulation with three DACs available for each block of 30 electrodes. 
   DACs A, C and E are available for the lower 30 electrodes, while
   DACs B, D and F are available for the upper 30.
   In the default paired mode AB, CD and EF would be paired.

   When working independently, each DAC is assigned to its own stimulus pattern
   readout unit, leaving the two previously unused readout units to be shared
   amound the three sidebands.

   Interesting registers:
   + 0x91D0: DAC stimulus to DAC stimulus pattern readout
   + 0x91D4: Sideband configuration (TODO: wrt what?)

** Sideband data
   A Sideband has two responsibilities: Firstly, controlling the switches connecting the stimulation DACs to 
   electrodes and controlling the Amplifier Protection("Blanking") of ADC data while a stimulus pulse 
   is active. 
  
   Secondly, the sideband can be utilized to send data to the USB, DSP or digital outputs on the IFB
   which are synchronous to the the running stimulation.
  
   For SHODAN, the latter is not a focus-area, so it will be ignored here.

   Each sideband controls electrodes with the following signals:
   * Bit 0: Amplifier Protection Switch on Headstage/Blanking 
   * Bit 3: Stimulation Switch Close 
   * Bit 4: Stimulus Selector Enable 
   * Bit 8: List Mode config ID increment on/to the Interface Board or Bit 15­8 List Mode config 
     ID when source of ID is switched to SB bits (TODO translate whatever the fuck this means)

   [[file:img/mcs_sideband.png]]
   The diagram shows an example stimulus pattern together with the sideband control signals. 
   As shown in the drawing, the Stimulation switch can open with the end of the Stimulus. 
   The Blanking signal should stay active for some additional time after stimulus is finished.
   Likewise, the Stimulation Selector should be kept for some additional time. 
   20µs is recommended.
  
** Electrode Configuration
   Each electrode is assigned to one of the three DACs in its STG subsystem, or to an inactive
   ground state, controlled by the 'DAC Multiplexer' registers 0x9160 - 0x916C.

   the Stimulation Enable registers at 0x158­0x15C connects the DAC multiplexer output with the
   electrode.
   
*** Asinine diagram: 
    
    [[file:img/mcs_dac_multiplexer.png]]
   In this wildly uninformative diagram the stim mux is shown as the red line, and DAC assignment
   as blue.

   Electrodes can be in two modes, "manual" and "auto".
   In manual mode, each electrode will be configured only by the stimulus select and enable registers.
   In auto mode, the stimulus and enable mux are additionally controlled by its assigned sideband.
   When assigned to a sideband, an electrode can only emit stimuli it is enabled and the sideband
   switch close signal is high. Similarily, only when the sideband stim selector enable is high can
   an electrode be assigned a source from the DAC select register (no selection = GND).

   In default mode DAC A/B is assigned to sideband 1, C/D to sideband 2, and E/F to band 3.
   This can be changed in the sideband select registers (0x9154)

** Electrode setup advice 
*** Decide wether your electrode is used as stimulation or measurement electrode (set
   * corresponding bit in register 0x120­0x12C and 0x158­0x15C) Assign your stimulation electrode to 
     a stimulation channel (DAC A to F) (set corresponding bits in register 0x160­0x16C) 
   * Stimulus channel setup advice Assign a sideband Channel to a stimulation channel (set in register 0x154)
